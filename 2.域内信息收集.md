# 域内信息收集

# 本机信息收集
## 1. 网络信息
`ipconfig /all`
## 2. 操作系统信息
`systeminfo`

`wmic computersystem`

`wmic qfe` 查询系统补丁

对比补丁，获得可用exp信息：[提权辅助网页](http://bugs.hacking8.com/tiquan/)
## 3. 已安装软件信息
`wmic product get name,version`

```powershell
Get-WmiObject -class Win32_Product | Select-Object -Property name,version
```
主要搜寻：
- 远程管理软件：VNC、Radmin、putty、SecureCRT、XShell等
- 浏览器cookie、保存密码、收藏夹、历史记录
- VPN客户端：anyconnect、openvpn等
- 邮件客户端：foxmail、thunderbird等
- 聊天软件：LYNC、IRC、Slack等
- 协调办公软件：Office 365、Google Docs、Quip、钉钉、saleforce等
- 云盘：SharePoint、DropBox、OneDrive、iCloud、Google Drive等
- PC端手机管理软件：PP助手、iTunes、91助手等

熟悉软件配置文件、缓存文件、密码文件的位置，有能力提取信息
## 4. 服务信息
`wmic service list brief`
## 5. 进程信息
`tasklist /svc`

`wmic process list brief`
## 6. 启动项信息
`wmic startup get command,caption`
## 7. 计划任务信息
`schtasks /query /fo LIST /v`
## 8. 用户账号信息
`net user`

`net localgroup administrators`

`query user || qwinsta`

`wmic useraccount where (Lockout=FALSE and Disabled=FALSE) get name,description,localaccount`

`wmic group get name,localaccount`
## 9. 端口信息
`netstat -ano`
## 10. 共享信息
`net share`

`wmic share get name,path,status`

# 域内环境探测
## 1. 域环境判断
- `ipconfig /all`获取主DNS后缀和DNS服务器地址，`nslookup`查询主DNS后缀，对比域控制器和DNS服务器地址
- `systeminfo`中“域”信息即域名，“登录服务器”为域控制器，如果“域”为`WORKGROUP`，表示不在域内
- `net config workstation`，“工作站域DNS名称”为域名，如果为`WORKGROUP`表示不在域内
- `net time /domain`，存在域时，如果当前用户不是域用户，则提示“拒绝访问”，否则将返回域控制器名称和时间；不存在域时，将提示“找不到域控制器”

## 2. 存活主机探测
### 利用NetBIOS
应用层协议为SMB，使用`nbtscan`，Windows和Linux都可使用，[源码地址](https://github.com/scallywag/nbtscan) [成品下载](http://www.unixwiz.net/tools/nbtscan.html#download)
```
nbtscan.exe 192.168.1.0/24
nbtscan.exe 192.168.1.1-254
```
![20201127223021yOKD8I](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201127223021yOKD8I.png)

最后一列的TOKEN代表着机器所开启的服务，主要有：
- SHARING，存在文件和打印共享服务，不一定有内容共享
- DC，可能是域控制器
- U=USER，登录有名为User的用户，准确性不高
- IIS，可能存在IIS服务器
- EXCHANGE，可能存在Exchange
- NOTES，可能安装了Lotus Notes邮件客户端
- ?，未识别出该机器的NetBIOS资源，可以使用`-F`参数再次扫描

### 利用ICMP协议
ping命令扫描网段：
```
for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr "TTL="
```

![20201127231206u5i0KN](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201127231206u5i0KN.png)
## 3. 端口扫描
- metasploit的`auxiliary/scanner/portscan/`
- PowerSploit的[Invoke-Portscan.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/Invoke-Portscan.ps1)
- Nishang的[Invoke-PortScan.ps1](https://github.com/samratashok/nishang/blob/master/Scan/Invoke-PortScan.ps1)
# 域信息收集
条件：至少需要域用户权限或本地SYSTEM权限

`net view /domain`查询域

`net view /domain:DOMAIN`查询域内主机名

![20201127234440DlhSx4](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201127234440DlhSx4.png)
`net group /domain`查询用户组

`net group "domain computers" /domain`查询域成员计算机

`net accounts /domain`查询域密码信息

`nltest /domain_trusts`查询域信任信息
## 定位域控
`nltest /DCLIST:DOMAIN`查看域控制器的机器名

`Nslookup -type=SRV_ldap._tcp`查看域控制器的主机名


`net time /domain`查看时间，通常时间服务器为主域控服务器

`net group "Domain Controllers" /domain`查看域控制器组

`netdom query pdc`查看主域控制器的机器名




