# 常见概念
- 组策略对象
组策略对象，GPO（Group Policy Object），即组策略设置的集合。
GPO中包含用于特定用户或计算机的策略信息和配置，可以看做是组策略工具生成的文档。

- 域（Domain）是一个有安全边界的计算机集合，即一个域的用户无法访问另一个域的资源。
- 域树（Tree）是多个域建立信任关系组成的集合。
- 域林（Forest）是多个域树建立信任关系组成的集合。
- 组的作用域分为三种：通用、全局、本地域。通用组的成员来源于域林中的任何域的用户账号、全局组和其他通用组；全局组可以在域间使用，可以利用全局组授予访问任何域上资源的权限，但成员必须是相同域的账户和全局组；本地域组主要授予本域内资源的访问权限。
- 信任关系具有双向传递性，即如果A信任B，B信任C，则A信任C。默认情况下，域间具有传递性，域林没有。
- 信任关系分为单向和双向，还分为可传递和不可传递。
- PDC（Primary Domain Controller）与BDC（Backup Domain Controller），PDC损坏不能工作时，有BDC就可以保证域正常运行。

---
#### 几个重要的用户和组
- Administrator/LocalStstem，本地权限最高的两个用户
- Domain Admins，域内权限最高的组
- Enterprise Admins，域林里权限最高的组
- Schema Admins，域林根域里的组，可以修改活动目录和域林的模式，非常重要
---
- UAC（User Account Control），即用户账户控制，在进行一些可能会影响系统安全的操作时，会弹窗询问，用户确认后才能执行。
- LM Hash从`Windows Vista`和`Windows Server 2008`之后被取消使用，但是在旧系统上还是能看到
- NTLM Hash即Windows系统下Security Account Manager中保存的用户密码hash，可以用来哈希传递（Pass-The-Hash）
- NTLMv1 Hash即Net-NTLM Hash，通常指网络中NTLM认证中的Hash，可尝试破解
- NTLMv1 Hash和NTMLv2 Hash可用来中继

# 技巧
### 1. 连接IPC$
#### Windows
```
net use \\10.10.10.10\ipc$ "password" /user:test.org\administrator
net use \\10.10.10.10\ipc$ "password" /user:administrator
```
![20201125102703hxcXaf](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125102703hxcXaf.png)
![202011251039038zXlhF](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/202011251039038zXlhF.png)
#### Linux
使用smbclient：
```
smbclient -L 10.10.10.10 -U administrator
smbclient \\\\10.10.10.10\\C$ -U administrator
smbclient -L 10.10.10.10 -U test.org/administrator
```
![20201125105800RaOmvx](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125105800RaOmvx.png)
![20201125105942aOitZy](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125105942aOitZy.png)

### 2. runas使用
`runas`可以让域用户或普通用户以管理员身份运行指定程序。
```
runas /netonly /user:test.org\administrator cmd
```
#### a.在同一台机器上产生多个用户身份的cmd窗口
可以通过此种方式使用不同用户连接不同机器，不会冲突
![20201125140751CYZKkF](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125140751CYZKkF.png)

#### b.有网络连接的时候才会产生身份认证
使用此方法在内网架设蜜罐，可以捕获攻击者的一些攻击行为。

`runas`以一个不存在的用户运行：
```
runas /netonly /user:god.org\honeypot cmd
```
用户名和密码都是随便输的，并不存在：
![20201125142310jluBFA](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125142310jluBFA.png)

但是内存中有此账户，并且可以抓到哈希，就是刚刚输入的密码哈希：
![20201125144131XbAiSA](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125144131XbAiSA.png)

借此可以在DC的Windows安全日志中查找此账户的登录情况，便可以定位和排查被入侵的主机：
![20201125145219KHZWlf](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125145219KHZWlf.png)

**（注：此方法我没有做过实践化，所以可用性如何目前还存疑）**

#### c.无论机器是否加入了域，都可以运行

### 3. 在Linux上侦查AD
使用`rpcclient`连接机器：
```
rpcclient -U test.org/administrator 10.10.10.10
```
枚举用户：
![20201125150523w8Fq0f](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125150523w8Fq0f.png)
![20201125150726xOIUyX](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/20201125150726xOIUyX.png)
查询用户信息：
![202011251509229RJNKg](https://adan0s-1256533472.cos.ap-nanjing.myqcloud.com/uPic/202011251509229RJNKg.png)
更多命令：
```shell
enumdomains #当前域
querydominfo #枚举域信息
enumdomgroups #枚举域组
querygroup <rid> #查询组信息
querygroupmem <rid> #查询组成员资格
getdompwinfo #域密码策略
getusrdompwinfo <rid> #用户密码策略
```

# 参考链接
https://3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D/
https://bitvijays.github.io/LFF-IPS-P3-Exploitation.html#active-directory-reconnaissance